-- Миграция для поддержки OAuth провайдеров (Google, Apple) и обязательного поля gender

-- 1. Обновляем поле gender: делаем его обязательным для новых пользователей
-- Но оставляем возможность NULL для существующих пользователей (миграция данных)
-- В приложении будет проверка: если gender === null, показываем экран завершения профиля

-- Добавляем комментарий к полю gender
COMMENT ON COLUMN profiles.gender IS 'Пол пользователя (обязателен для доступа к приложению). NULL означает, что профиль не завершен.';

-- 2. Создаем индексы для OAuth провайдеров (если нужно)
-- Supabase Auth автоматически создает записи в auth.users при OAuth входе

-- 3. Обновляем триггер handle_new_user для поддержки OAuth
-- Триггер уже обновлен в миграции 002_universal_user_id.sql

-- 4. Добавляем проверку на уровне приложения:
-- Если gender IS NULL, пользователь должен завершить профиль перед доступом к приложению

-- Комментарий:
-- - Поле gender не делается NOT NULL в БД, чтобы не сломать существующих пользователей
-- - Проверка gender === null выполняется в приложении (TypeScript/React)
-- - Если gender === null, показывается экран CompleteProfileScreen
-- - После выбора пола пользователь получает доступ к приложению
